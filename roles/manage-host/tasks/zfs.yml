---
- name: install and configure zfs pool
  apt:
    name: zfsutils-linux
    state: present

- shell: zpool status {{ zfs_pool }}
  register: ifexists

- shell: /sbin/zpool import -fm {{ zfs_pool }}
  when: ifexists.stdout is search("/cannot/")

- shell: zpool add -f {{ zfs_pool }} cache {{ zfs_cache }}
  when: ifexists.stdout is search("/cannot/")

- shell: zpool add -f {{ zfs_pool }} log {{ zfs_log }}
  when: ifexists.stdout is search("/cannot/")

- shell: echo 'zpool remove pool <failed_device>'
  register: myecho

- debug: msg="{{ myecho.stdout }}"

- name: configure zed and bi-weekly scrub
  template:
    src: zed.j2
    dest: /etc/zfs/zed.d/zed.rc
    owner: root
    group: root
    mode: "u=rw,g=,o="

- template:
    src: systemd-service.j2
    dest: /etc/systemd/system/zpool-scrub.service
    owner: root
    group: root
    mode: "u=rw,g=r,o=r"
  vars:
    - service_description: zpool scrub service
    - service_command: /sbin/zpool scrub pool
    - service_user: root
    - service_group: root

- template:
    src: systemd-timer.j2
    dest: /etc/systemd/system/zpool-scrub.timer
    owner: root
    group: root
    mode: "u=rw,g=r,o=r"
  vars:
    - timer_description: zpool scrub timer
    - timer_oncalendar: Tue *-*-* 09:00:00
    - service_name: zpool-scrub

- systemd:
    name: zpool-scrub
    enabled: yes