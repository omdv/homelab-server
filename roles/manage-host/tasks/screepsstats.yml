---
- name: download file
  shell: wget $(curl -L -s https://api.github.com/repos/screepers/screeps-stats/releases/latest | grep tarball_url | head -n 1 | cut -d '"' -f 4) -O screepsstats.tgz
  become: yes
  become_user: "{{ user }}"
  args:
    warn: false

- name: unpack
  shell: mkdir screepsstats; tar zxvf screepsstats.tgz -C ./screepsstats --strip 1
  become: yes
  become_user: "{{ user }}"
  args:
    warn: false

- name: move to final directory
  shell: mv screepsstats /opt/screepsstats --force && cd /opt/screepsstats
  become: yes
  ignore_errors: yes

- name: copy settings
  copy:
    src: screeps_settings.yaml
    dest: /home/{{ user }}/.screeps_settings.yaml
    owner: "{{ user }}"
    group: "{{ user }}"
    force: yes
  become: yes
  become_user: "{{ user }}"

- pip:
    name:
      - virtualenv
      - lxml

- name: compile
  shell: cd /opt/screepsstats && make
  become: yes
  become_user: "{{ user }}"

- name: install
  shell: make install
  become: yes