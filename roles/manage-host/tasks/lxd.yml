---
- name: install lxd and create group and user
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - snapd
    - bridge-utils

- group:
    name: lxd
    state: present

- user: name={{ user }}
        groups=lxd
        append=yes

- shell: snap install lxd

- name: configure lxd public ip interfaces
  shell: cp /etc/network/interfaces /etc/network/interfaces.bak
  when: ansible_default_ipv4.interface != "br0"

- template:
    src: interfaces.j2
    dest: /etc/network/interfaces
    owner: root
    group: root
    mode: "u=rw,g=r,o=r"
  when: ansible_default_ipv4.interface != "br0"

- reboot:
    reboot_timeout: 30
  when: ansible_default_ipv4.interface != "br0"

- name: initialize lxd
  shell: lxd init --auto --storage-backend=zfs --storage-pool={{ zfs_pool }}/lxd
  ignore_errors: yes

- name: configure lxd remote control
  shell: /snap/bin/lxc config set core.https_address [::]:8443 && /snap/bin/lxc config set core.trust_password replace-this-with-a-secure-password