---
- name: copy sources list to proxmox
  copy:
    src: sources.list
    dest: /root/
    owner: root
    group: root
    mode: 0644

- name: create container
  shell: pct create {{ item.value.id }} {{ lxc_template }} \
    -storage {{ lxc_storage }} \
    --password {{ lookup('env','PVE_LXC_ROOT_PASS') }} \
    --rootfs {{ lxc_size }} \
    --hostname {{ item.key }}.local \
    --cores {{ lxc_cpus }} \
    --swap {{ lxc_swap }} \
    --memory {{ lxc_memory }} \
    --net0 name=eth0,bridge=vmbr0,ip={{ lxc_subnet }}{{ item.value.id }}/24,gw={{ lxc_gateway }} \
    --ssh-public-keys /root/.ssh/authorized_keys \
    --start 0 \
    --onboot 1 \
    --unprivileged 1
  with_dict: "{{ containers }}"

- name: add mount points
  shell: echo "{{ item.value.mounts }}" >> "/etc/pve/lxc/{{ item.value.id }}.conf"
  with_dict: "{{ containers }}"

- name: start containers
  shell: pct start {{ item.value.id }}
  with_dict: "{{ containers }}"

- name: wait 5s for container network to start
  wait_for: timeout=5

- name: push sources list to container
  shell: pct push {{ item.value.id }} /root/sources.list /etc/apt/sources.list
  with_dict: "{{ containers }}"

- name: update & upgrade
  shell: lxc-attach -n {{ item.value.id }} -- bash -c 'apt-get -y update && apt-get -y upgrade'
  with_dict: "{{ containers }}"

- name: install openssh and sudo
  shell: lxc-attach -n {{ item.value.id }} -- bash -c 'apt-get -y install openssh-server sudo'
  with_dict: "{{ containers }}"

- name: update sshd config
  shell: lxc-attach -n {{ item.value.id }} -- bash -c 
    'echo "PermitRootLogin without-password" >> {{ ssh_config }} &&
    echo "PasswordAuthentication no" >> {{ ssh_config }}'
  with_dict: "{{ containers }}"

- name: reload openssh
  shell: lxc-attach -n {{ item.value.id }} -- systemctl restart ssh
  with_dict: "{{ containers }}"

- name: add the host group
  add_host:
    hostname: "192.168.0.{{ item.value.id }}"
    group: "{{ item.value.type }}"
  with_dict: "{{ containers }}"
