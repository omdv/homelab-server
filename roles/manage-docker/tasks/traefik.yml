---
- name: create persistent dir for traefik
  file:
    path: "{{ config_volume }}/traefik"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"

- name: copy traefik.toml
  copy:
    src: traefik.toml
    dest: "{{ config_volume }}/traefik/traefik.toml"
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0644

- name: create empty acme.json
  file:
    path: "{{ config_volume }}/traefik/acme.json"
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0600

- name: start traefik container
  docker_container:
    name: traefik
    state: started
    restart: yes
    restart_policy: always
    labels:
      traefik.enable: "false"
      launchpanel.enabled: "yes"
      launchpanel.ip: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"
      launchpanel.name: "traefik"
      launchpanel.port: "8080"
    ports:
      - 8000:80
      - 443:443
      - 8080:8080
    image: traefik:latest
    command: --api --docker --docker.domain=e2.pe
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "{{ config_volume }}/traefik/traefik.toml:/traefik.toml"
      - "{{ config_volume }}/traefik/acme.json:/acme.json"