---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dyndns
  namespace: kube-system
  labels:
    app: dyndns

spec:
  schedule: "*/15 * * * *"
  startingDeadlineSeconds: 200
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: namecheap
              image: busybox
              command: ["/bin/sh", "-c"]
              args:
                - IP_ADDR=$(wget -qO- ifconfig.me | xargs echo) &&
                  wget -S "${BASE_URL}?host=@&domain=#HOMELAB_DOMAIN#&password=${PASS}&ip=${IP_ADDR}" -O /dev/null &&
                  wget -S "${BASE_URL}?host=*&domain=#HOMELAB_DOMAIN#&password=${PASS}&ip=${IP_ADDR}" -O /dev/null
              env:
                - name: PASS
                  valueFrom:
                    secretKeyRef:
                      name: dyndns-secret
                      key: NAMECHEAP_DNS_PASS
                - name: BASE_URL
                  value: "https://dynamicdns.park-your-domain.com/update"
          restartPolicy: OnFailure
