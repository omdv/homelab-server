# https://github.com/gabe565/charts/blob/main/charts/headscale/values.yaml
#
# IMPORTANT NOTE
#
# This chart inherits from our common library chart. You can check the default values/options here:
# https://github.com/bjw-s/helm-charts/blob/a081de5/charts/library/common/values.yaml
#
headscale:
  image:
    repository: ghcr.io/juanfont/headscale
    pullPolicy: IfNotPresent
    tag: 0.23.0

  args: ["serve"]

  env:
    #https://github.com/juanfont/headscale/blob/main/config-example.yaml
    HEADSCALE_DNS_BASE_DOMAIN: "mydomain.sh"
    HEADSCALE_PREFIXES_V4: "100.64.0.0/10"
    HEADSCALE_PREFIXES_V6: "fd7a:115c:a1e0::/48"

    HEADSCALE_DNS_NAMESERVERS_GLOBAL: "1.1.1.1 1.0.0.1"
    HEADSCALE_DNS_MAGIC_DNS: "true"

    HEADSCALE_DERP_URLS: "https://controlplane.tailscale.com/derpmap/default"
    HEADSCALE_DERP_AUTO_UPDATE_ENABLED: "true"
    HEADSCALE_DERP_UPDATE_FREQUENCY: "24h"

    HEADSCALE_EPHEMERAL_NODE_INACTIVITY_TIMEOUT: "30m"

  service:
    main:
      ports:
        ui:
          port: 80
        http:
          port: 8000
        metrics:
          port: 9090
        grpc:
          enabled: false
          port: 50443

  ingress:
    main:
      enabled: true
      ingressClassName: nginx
      hosts:
        - host: tailscale.hut.sh
          paths:
            - path: /
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
      tls:
        - hosts:
            - tailscale.hut.sh
          secretName: my-certs-headscale
    ui:
      enabled: true
      ingressClassName: nginx
      hosts:
        - host: tailscale.hut.sh
          paths:
            - path: /web
              service:
                port: 80
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        nginx.ingress.kubernetes.io/auth-url: "https://auth.hut.sh/oauth2/auth"
        nginx.ingress.kubernetes.io/auth-signin: "https://auth.hut.sh/oauth2/start?rd=https://$host$uri"
        hajimari.io/enable: "true"
      tls:
        - hosts:
            - tailscale.hut.sh
          secretName: my-certs-headscale-ui

  configMaps:
    acl:
      enabled: false
      data:
        policy:

  persistence:
    config:
      enabled: true
      mountPath: /etc/headscale
      existingClaim: pvc-headscale

  postgresql:
    enabled: false

  sidecars:
    ui:
      image: ghcr.io/gurucomputing/headscale-ui:latest

  serviceMonitor:
    main:
      enabled: false
      endpoints:
        - port: metrics
          scheme: http
          path: /metrics
          interval: 30s
          scrapeTimeout: 10s

  resources:
    limits:
      cpu: 80m
      memory: 256Mi
    requests:
      cpu: 10m
      memory: 64Mi
