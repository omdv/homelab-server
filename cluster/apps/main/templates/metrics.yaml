---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: metrics-helm
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "5"
spec:
  destination:
    namespace: metrics
    server: {{ .Values.spec.destination.server }}
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 31.0.0
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
  helm:
    releaseName: kube-metrics
    skipCrds: true
    values: |
      fullnameOverride: prom
      kubeEtcd:
        enabled: true
      kubeControllerManager:
        enabled: false
      kubeScheduler:
        enabled: false
      kubeProxy:
        enabled: false
      defaultRules:
        rules:
          time: false
      prometheusOperator:
        # Setting this option to 0 to disable cpu limits
        # see https://github.com/prometheus-operator/prometheus-operator/blob/master/cmd/operator/main.go#L175
        configReloaderCpu: 0
      grafana:
        enabled: false
      prometheus-node-exporter:
        fullnameOverride: node-exporter
      kubeStateMetrics:
        enabled: true
      nodeExporter:
        serviceMonitor:
          relabelings:
            - action: replace
              regex: (.*)
              replacement: $1
              sourceLabels:
                - __meta_kubernetes_pod_node_name
              targetLabel: kubernetes_node
      kubelet:
        serviceMonitor:
          metricRelabelings:
            - action: replace
              sourceLabels:
                - node
              targetLabel: instance
