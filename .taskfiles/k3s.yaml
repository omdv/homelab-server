---
version: "3"

tasks:
  init:zfspv:
    desc: Install zfs-localpv
    dir: ./
    cmds:
      - "kubectl apply -f https://openebs.github.io/charts/zfs-operator.yaml"
      - "kubectl apply -f {{.CLUSTER_DIR}}/init/zfs-sc.yaml"
      - 'kubectl patch storageclass local-path -p ''{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'''
      - 'kubectl patch storageclass zfspv -p ''{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'''

  init:vault:
    desc: Install vault
    dir: ./
    cmds:
      - "kubectl create namespace vault --dry-run=client -o yaml | kubectl apply -f -"
      - "kubectl create secret generic kms-creds -n vault --from-file=.cloud-config/credentials.json --dry-run=client -o yaml | kubectl apply -f -"
      - "helm repo add hashicorp https://helm.releases.hashicorp.com && helm repo update"
      - "helm install vault hashicorp/vault -n vault -f {{.CLUSTER_DIR}}/init/vault-values.yaml"
      - "kubectl exec -n vault vault-0 -- vault operator init -format=json > .cloud-config/vault-keys.json"
