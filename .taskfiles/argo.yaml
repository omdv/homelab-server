---
version: "3"

vars:
  LOAD_BALANCER_PATCH: '{"spec": {"type": "LoadBalancer"}}'

tasks:
  install:
    desc: Install ArgoCD
    dir: ./
    cmds:
      - "kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -"
      - "cat ~/.config/sops/age/keys.txt |\
        kubectl -n argocd create secret generic sops-age \
        --from-file=age.agekey=/dev/stdin --save-config --dry-run=client -o yaml |\
        kubectl apply -f -"
      - "kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
      - 'kubectl patch svc argocd-server -n argocd -p ''{"spec": {"type": "LoadBalancer"}}'''
      - "argocd login {{.HOMELAB_LOCAL_IP}}:80 --insecure --username admin \
        --password $(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d)"
      - "argocd account update-password --current-password \
        $(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d) \
        --new-password {{.HOMELAB_ARGOCD_PASSWORD}}"
      - 'kubectl patch svc argocd-server -n argocd -p ''{"spec": {"type": "ClusterIP"}}'''
      - "kubectl delete secret/argocd-initial-admin-secret -n argocd "

  uninstall:
    desc: Uninstall ArgoCD
    dir: ./
    cmds:
      - "kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
