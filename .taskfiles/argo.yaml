---
version: "3"

tasks:
  install:
    desc: Install ArgoCD
    dir: ./
    cmds:
      - "kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -"
      - "cat ~/.config/sops/age/keys.txt |\
        kubectl -n argocd create secret generic sops-age \
        --from-file=age.agekey=/dev/stdin --save-config --dry-run=client -o yaml |\
        kubectl apply -f -"
      - "kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
      - "kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/applicationset/v0.3.0/manifests/install.yaml"
      # - "kubectl patch svc argocd-server -n argocd -p ''{"spec": {"type": "LoadBalancer"}}'''
      # - "kubectl port-forward svc/argocd-server -n argocd 8080:443 &"
      - "argocd login localhost:8080 --insecure --username admin \
        --password $(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d)"
      - "argocd account update-password --current-password \
        $(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d) \
        --new-password {{.HOMELAB_ARGOCD_PASSWORD}}"
      # - 'kubectl patch svc argocd-server -n argocd -p ''{"spec": {"type": "ClusterIP"}}'''
      # - "pgrep kubectl | xargs kill -9"
      - "kubectl delete secret/argocd-initial-admin-secret -n argocd"
      - "argocd cluster add default --in-cluster --yes"

  uninstall:
    desc: Uninstall ArgoCD
    dir: ./
    cmds:
      - "kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
      - "kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj-labs/applicationset/v0.3.0/manifests/install.yaml"
