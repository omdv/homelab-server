---
- name: install k3s
  shell: curl -sfL https://get.k3s.io | \
    INSTALL_K3S_EXEC="--disable traefik --disable local-storage --disable metrics-server" \
    sh -s - --write-kubeconfig-mode 644 --tls-san 192.168.0.30
  args:
    warn: false

- name: Create context for kube-system namespace
  shell: kubectl config set-context homelab --namespace=kube-system --cluster=default --user=default

- name: Replace a localhost entry with our IP
  lineinfile:
    path: /etc/rancher/k3s/k3s.yaml
    regexp: 'https://127\.0\.0\.1'
    line: "    server: https://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:6443"

- name: fetch k3s config file
  fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /home/om/.kube/config
    flat: true
# - name: merge with current config using krew konfig
#   shell: kubectl konfig import --save /home/om/.kube/k3s.config
#   delegate_to: 127.0.0.1
#   become: false

# - name: delete fetched config file
#   file:
#     state: absent
#     path: /home/om/.kube/k3s.config
#   delegate_to: 127.0.0.1
#   become: false
